stages:
 - build
 #- push_to_ecr
 #- deploy

variables:
  # this variable can be overriden by pipeline run variable
  ENV: "sandbox"

.sandbox_triggers: &sandbox_triggers
  refs:
    - sandbox

.qat_triggers: &qat_triggers
  refs:
    - qat

.poc_triggers: &poc_triggers
  refs:
    - poc


build-sandbox:
  stage: build
  tags:
    - front
  script:
    - rm -rf src/tools &&  cd src
    - git clone http://$USER:$CI_TOKEN@gitlab.tooling-sapien.network/group-tools/tools.git
    #- git submodule init   &&  git submodule update --remote
    - cd ..
    ##- git pull --recurse-submodule
    - export KUBECONFIG=~/.kube/kubeconfig_sapien-sandbox-cluster
    - export AWS_PROFILE=sapien-sandbox
    - export AWS_REGION=us-east-2
    ### service env vars
    - export ENV=SANDBOX
    - export NODE_ENV=SANDBOX
    - export S3_BUCKET_NAME_SANDBOX=sapien-sandbox
    - envsubst < .env-temp > .env
    ### login to ecr
    - aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 994750220687.dkr.ecr.us-east-2.amazonaws.com
    - docker build -t front-v3:latest .
    - docker tag front-v3:latest 994750220687.dkr.ecr.us-east-2.amazonaws.com/front-v3:latest
    - docker push 994750220687.dkr.ecr.us-east-2.amazonaws.com/front-v3:latest
    - export ENV=sandbox
    - cd eks-manif &&  envsubst <  front-dep-temp.yml > front-dep.yml
    - cat front-dep.yml
    - kubectl delete -f  front-dep.yml && kubectl apply -f front-dep.yml
  only:
    <<: *sandbox_triggers

build-qat:
  stage: build
  tags:
    - front-qat
  script:
    - rm -rf src/tools &&  cd src
    - git clone http://$USER:$CI_TOKEN@gitlab.tooling-sapien.network/group-tools/tools.git
    #- git submodule sync && git submodule update
    - cd ..
    #- ls -l src/tools
    - export KUBECONFIG=~/.kube/kubeconfig_sapien-qat-cluster
    - export AWS_PROFILE=sapien-qat
    - export AWS_REGION=us-east-2
    - export ENV=QAT
    - export S3_BUCKET_NAME_QAT=sapien-qat
    - export NODE_ENV=QAT
    - export LOG_LEVEL=debug
    - envsubst < .env-temp > .env
    ### login to ecr
    - aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 081984521558.dkr.ecr.us-east-2.amazonaws.com
    - docker build -t front-v3:latest .
    - docker tag front-v3:latest 081984521558.dkr.ecr.us-east-2.amazonaws.com/front-v3:latest
    - docker push 081984521558.dkr.ecr.us-east-2.amazonaws.com/front-v3:latest
    - export ENV=qat
    - cd eks-manif &&  envsubst <  front-dep-temp-q.yml > front-dep.yml
    - cat front-dep.yml
    - kubectl delete -f  front-dep.yml && kubectl apply -f front-dep.yml
  only:
    <<: *qat_triggers

build-poc:
  stage: build
  tags:
    - front-poc
  script:
    - rm -rf src/tools &&  cd src
    - git clone http://$USER:$CI_TOKEN@gitlab.tooling-sapien.network/group-tools/tools.git
    #- git submodule init   &&  git submodule update --remote
    - cd ..
    ##- git pull --recurse-submodule
    - export KUBECONFIG=~/.kube/kubeconfig_sapien-poc-cluster
    - export AWS_PROFILE=sapien-poc
    - export AWS_REGION=us-east-2
    - export ENV=POC
    - export S3_BUCKET_NAME_POC=sapien-poc
    - export NODE_ENV=POC
    - export LOG_LEVEL=debug
    - envsubst < .env-temp > .env
    ### login to ecr
    - aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 081984521558.dkr.ecr.us-east-2.amazonaws.com
    - docker build -t front-v3:latest .
    - docker tag front-v3:latest 081984521558.dkr.ecr.us-east-2.amazonaws.com/front-v3:latest
    - docker push 081984521558.dkr.ecr.us-east-2.amazonaws.com/front-v3:latest
    - export ENV=poc
    - cd eks-manif &&  envsubst <  front-dep-temp-q.yml > front-dep.yml
    - cat front-dep.yml
    - kubectl delete -f  front-dep.yml && kubectl apply -f front-dep.yml
  only:
    <<: *poc_triggers
